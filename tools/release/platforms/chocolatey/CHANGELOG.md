General bug fixes and performance fixes.